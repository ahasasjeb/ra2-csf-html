<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<title>CSF 在线编辑器</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;margin:0;padding:1rem;background:#f5f7fa;color:#222;}
h1{font-size:1.8rem;margin:0 0 1rem;font-weight:600;}
.container{max-width:1200px;margin:auto;}
.controls{display:flex;flex-wrap:wrap;gap:.5rem;margin-bottom:1rem;}
table{border-collapse:collapse;width:100%;background:#fff;}
th,td{border:1px solid #ddd;padding:.5rem;}
th{background:#eee;text-align:left;}
input[type=text]{width:100%;border:none;background:transparent;outline:none;}
textarea{width:100%;height:4.5rem;resize:vertical;border:none;background:transparent;outline:none;font-family:inherit;}
button{cursor:pointer;border:none;padding:.5rem 1rem;border-radius:.25rem;font-size:.9rem;}
button.primary{background:#2563eb;color:#fff;}
button.secondary{background:#e2e8f0;}
button:disabled{opacity:.5;cursor:not-allowed;}
.file-input::file-selector-button{padding:.5rem 1rem;border:none;border-radius:.25rem;background:#2563eb;color:#fff;cursor:pointer;}
footer{margin-top:2rem;font-size:.8rem;color:#555;text-align:center;}
</style>
</head>
<body>
<div class="container">
<h1>CSF 在线编辑器</h1>

<div class="controls">
  <input class="file-input" type="file" accept=".csf" id="fileInput">
  <button class="secondary" id="newBtn">新建空白</button>
  <button class="secondary" id="addBtn">新增条目</button>
  <button class="primary" id="saveBtn">保存 CSF</button>
</div>

<div style="overflow-x:auto">
<table id="csfTable">
  <thead>
    <tr><th style="width:25%">Label</th><th>Value (支持换行)</th></tr>
  </thead>
  <tbody></tbody>
</table>
</div>

<footer>本工具纯前端实现，文件仅在本地浏览器处理，不会上传。</footer>
</div>

<script>
/* ----------- CSF Utilities ----------- */
function invertBytes(uint8){const o=new Uint8Array(uint8.length);for(let i=0;i<uint8.length;i++)o[i]=(~uint8[i])&0xFF;return o;}
function decodeValue(raw){return new TextDecoder('utf-16le').decode(invertBytes(raw));}
function encodeValue(str){return invertBytes(new TextEncoder('utf-16le').encode(str));}
function parseCSF(buffer){const dv=new DataView(buffer);let off=0;const magic=String.fromCharCode(...new Uint8Array(buffer,0,4));if(magic!==" FSC")throw new Error('不是有效CSF文件');off=4;const version=dv.getUint32(off,true);off+=4;const numLabels=dv.getUint32(off,true);off+=4;const numStrings=dv.getUint32(off,true);off+=4;off+=4;const lang=dv.getUint32(off,true);off+=4;const entries=[];for(let i=0;i<numLabels;i++){const marker=String.fromCharCode(...new Uint8Array(buffer,off,4));off+=4;if(marker!==" LBL")throw new Error('结构异常: 未找到 LBL');const strCount=dv.getUint32(off,true);off+=4;const nameLen=dv.getUint32(off,true);off+=4;const nameBytes=new Uint8Array(buffer,off,nameLen);off+=nameLen;const label=new TextDecoder().decode(nameBytes);const valMarker=String.fromCharCode(...new Uint8Array(buffer,off,4));off+=4;const valLen=dv.getUint32(off,true);off+=4;const raw=new Uint8Array(buffer,off,valLen*2);off+=valLen*2;const value=decodeValue(raw);if(valMarker==="WRTS"){const extraLen=dv.getUint32(off,true);off+=4+extraLen;}entries.push({label,value});}return entries;}
function buildCSF(entries){const encoder=new TextEncoder();let size=0x18;entries.forEach(e=>{const nameBytes=encoder.encode(e.label);const valBytes=encodeValue(e.value+"\r\n");size+=4+4+4+nameBytes.length;size+=4+4+valBytes.length;});const buffer=new ArrayBuffer(size);const dv=new DataView(buffer);let off=0;new Uint8Array(buffer,off,4).set([0x20,0x46,0x53,0x43]);off+=4;dv.setUint32(off,3,true);off+=4;dv.setUint32(off,entries.length,true);off+=4;dv.setUint32(off,entries.length,true);off+=4;off+=4;dv.setUint32(off,0,true);off+=4;entries.forEach(e=>{const nameBytes=encoder.encode(e.label);const valBytes=encodeValue(e.value+"\r\n");new Uint8Array(buffer,off,4).set([0x20,0x4c,0x42,0x4c]);off+=4;dv.setUint32(off,1,true);off+=4;dv.setUint32(off,nameBytes.length,true);off+=4;new Uint8Array(buffer,off,nameBytes.length).set(nameBytes);off+=nameBytes.length;new Uint8Array(buffer,off,4).set([0x20,0x52,0x54,0x53]);off+=4;dv.setUint32(off,valBytes.length/2,true);off+=4;new Uint8Array(buffer,off,valBytes.length).set(valBytes);off+=valBytes.length;});return buffer;}
/* ----------- UI logic ----------- */
let csfData=[];const tbody=document.querySelector('#csfTable tbody');function renderTable(){tbody.innerHTML='';csfData.forEach((row,idx)=>{const tr=document.createElement('tr');const tdLabel=document.createElement('td');const input=document.createElement('input');input.type='text';input.value=row.label;input.oninput=e=>{row.label=e.target.value;};tdLabel.appendChild(input);const tdValue=document.createElement('td');const textarea=document.createElement('textarea');textarea.value=row.value;textarea.oninput=e=>{row.value=e.target.value;};tdValue.appendChild(textarea);tr.appendChild(tdLabel);tr.appendChild(tdValue);tbody.appendChild(tr);});}
document.getElementById('fileInput').addEventListener('change',e=>{const file=e.target.files[0];if(!file)return;const reader=new FileReader();reader.onload=evt=>{try{csfData=parseCSF(evt.target.result);renderTable();}catch(err){alert(err.message);}};reader.readAsArrayBuffer(file);});
document.getElementById('addBtn').addEventListener('click',()=>{csfData.push({label:'NEW_LABEL',value:''});renderTable();});
document.getElementById('newBtn').addEventListener('click',()=>{csfData=[];renderTable();document.getElementById('fileInput').value='';});
document.getElementById('saveBtn').addEventListener('click',()=>{if(csfData.length===0){alert('没有内容可保存');return;}try{const buf=buildCSF(csfData);const blob=new Blob([buf],{type:'application/octet-stream'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='stringtable_new.csf';a.click();URL.revokeObjectURL(url);}catch(err){alert('保存失败: '+err.message);}});
</script>
</body>
</html>
